name: Release
on:
  workflow_call:
    inputs:
      dry-run:
        description: 'Compiles the app but not upload artifacts to distribution server'
        default: false
        required: false
        type: boolean

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true


defaults:
  run:
    shell: 'bash'


jobs:
  draft_release:

    permissions:
      contents: write # Allows this job to create releases

    strategy:
      fail-fast: false
      matrix:
        # macos-13 is x64, macos-latest is arm64
        os: [ macos-latest, macos-13, windows-latest ]

    runs-on: ${{ matrix.os }}

    steps:
      # Setup environment
      - name: Update node to 22.x before enabling corepack
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
      - name: Enable Corepack
        run: corepack enable
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup Node w/ Yarn Cache
        uses: actions/setup-node@v4
        with:
          cache: 'yarn'
          node-version: '22.x'
      - name: Yarn Install
        run: yarn install --immutable

      - run: yarn build

      - name: Compile artifacts ${{ inputs.dry-run && '' || 'and upload them to github release' }}
        run: ./node_modules/.bin/electron-builder --config electron-builder.json --publish ${{ inputs.dry-run && 'never' || 'always' }}
        env:
          # Code Signing params
          # See https://www.electron.build/code-signing
          # CSC_LINK: ''
          # CSC_KEY_PASSWORD: ''
          # Publishing artifacts
          GH_TOKEN: ${{ secrets.github_token }} # GitHub token, automatically provided (No need to define this secret in the repo settings)
